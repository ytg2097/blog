---
sidebar: auto
---

# 分布式事务

## 分布式事务的基础理论知识

### CAP

- Partition tolerance 分区容错性

> 如果存储系统只运行在一个节点上, 要么系统整个崩溃, 要么正常运行. 一旦针对同一服务的存储系统分布到多个节点, 那么整个存储系统就会存在分区的可能性.
> 比如两个存储节点之间联通的网络段卡, 就会形成分区, 一般来讲, 为了提高服务质量, 同意份数据存放在不同城市非常正常, 因此节点之间存在分区也很正常. 
> 
> 分区容错性的定义为: 除全部网络节点全部故障之外, 所有子节点集合的故障不允许导致整个系统出现不正确响应. 即时部分故障, 施加的操作也可以完成. 
- Consistency 一致性

> 在分布式系统中, 往往会存在多个数据库, 这里的一致性指的是用户的一次对数据的修改, 如果涉及了多个数据库, 要么全部成功, 要么全部失败.
> 如果一个存储系统可以保证一致性, 那么用户读写的数据可以保证是最新的, 不会发生不同客户端在不同的存储节点读取到不同副本的情况. 

- Availability 可用性

> 即客户端在访问数据时, 必定能够得到响应, 但系统可用并不代表存储系统的所有节点提供的数据是一致的. 往往我们会对不用的应用设定一个最长的响应时间, 
> 超过这个时间仍没有响应的服务则称之为不可用

一个存储系统不可能同时满足以上三个特性, 只能同时满足两个, 也就是CA,CP,AP. 由于分布式系统中分区情况始终会存在, 所以分区容错性必须保证, 所以必须在
CP和AP之间做出抉择. 

::: tip CP
 不满足可用性, 相当于每个请求都需要在各个节点之间保证强一致性, 而出现分区情况时则会导致同步的时间无线延长.
:::
::: tip AP
保证高可用的同时允许分区, 则需要放弃一致性. 一旦分区发生, 节点之间数据时区联系, 为了高可用, 每个节点只能使用本地数据提供服务, 这样会导致全局数据的不一致性.
PS: 在涉及钱的业务场景中, 尽量不要采用AP
:::
### ACID

ACID 指的是在数据库中事务所具有的四个特性: 原子性(Atomicity), 一致性(Consistency), 隔离性(Isolation), 持久性(Durability).

#### 原子性

一个事务中的操作要么全部完成, 要么全部不完成. 如果事务过程中出现错误, 要回滚到事务开始前的状态.

#### 一致性

一个事务执行前后数据库应该处于一致性状态. 如果事务成功的完成, 那么所有数据都应该从一个有效的状态转移到另一个有效的状态, 如果过程中出现错误, 所有的状态变化应该自动的回滚到原始状态

#### 隔离性

在并发环境中, 当不同的事务同时操作相同数据时, 每个事务都有各自的完整数据空间, 由并发事务所做的修改必须与其他并发事务所做的修改隔离.
事务查询时, 数据所处的状态要么是另一个事务修改它之前的状态, 要么是另一个事务修改它之后的状态, 事务不能查看到中间状态的数据.
#### 持久性

指的是只要事务成功结束, 那么他对数据库所做的更新就必须永久保存下来, 数据库重启后也能恢复到事务成功结束时的状态. 

### BASE

BASE全称为BasicallyAvailable(基本可用), Soft-state(软状态/柔性事务), Eventually Consistent(最终一致性). Base模型在理论逻辑上相反与ACID, 它牺牲了强一致性, 获得了可用性与分区容错性.

目前常用的实现分布式事务的方式有三种: 两段式提交AT, 三段式提交TCC补偿模式, Saga

## 两段式提交

## 三段式提交

## Saga

Saga是一个长期运行的事务, 由多个本地事务组成, 每个本地事务有响应的执行模块和补偿模块, 任意一个本地事务出错时可以调用相关事务对应的不长方法进行补偿, 从而实现最终一致性


